# ADR-006: Основное решение — Мультитенантная SaaS-платформа для агрохолдингов

**Статус:** ✅ Принято  
**Участники:** Степанов Андрей  
**Дата:** 28.12.2025  
**Ссылки:** Основано на ADR-004 (Основное решение MVP), эволюция для Задания 5  

---

## 1. Контекст

После успешного MVP система автоматизации ферм эволюционирует в **коммерческую SaaS-платформу** для сторонних агрохолдингов. Архитектура должна поддерживать:

- полную изоляцию данных между клиентами (тенантами),
- гибкую монетизацию (тарифы, биллинг, российские платёжные системы),
- самообслуживание и публичное API,
- горизонтальное масштабирование,
- сохранение ключевых возможностей MVP: ИИ на edge, работа offline, управление оборудованием.

---

## 2. Требования (дополненные SaaS)

см. ADR-003

---

## 3. Решение: Мультитенантная архитектура с изоляцией на уровне БД

### Архитектурный обзор

Система построена по принципу **«единая платформа — множество клиентов»**, где:

- Каждый клиент (**тенант**) — агрохолдинг с одним или несколькими фермами.
- Данные тенанта **физически изолированы** в отдельной PostgreSQL-БД.
- Все клиенты используют **один и тот же код и инфраструктуру**, но с разными конфигурациями.
- Текущая компания — **один из тенантов**, без привилегий.

### Ключевые компоненты

| Контекст | Ответственность | Контейнеры |
|--------|------------------|-----------|
| **Маршрутизация тенанта** | Определение `tenant_id` по subdomain или API key | `Tenant Service` |
| **Аутентификация** | Управление пользователями, ролями, API keys | `User Service`, `Users DB` |
| **API** | Единая точка входа для клиентов и внутренних сервисов | `API Gateway` |
| **Биллинг** | Тарифы, подписки, интеграция с платёжными системами | `Billing Service`, `Usage Collector`, `Payment Adapter`, `Invoice Generator` |
| **Аналитика и ИИ** | Обнаружение инцидентов, агрегация метрик | `Сервис аналитики`, `ClickHouse (per tenant)` |
| **Уведомления** | Email/SMS/локальные оповещения | `Сервис уведомлений`, `Kafka` |
| **Edge-уровень** | Автономная работа фермы, ИИ, буферизация | `Фермерский агент с ИИ`, `SQLite` |

### Технологический стек

- **API Gateway**: C#, REST/gRPC, авторизация
- **Базы данных**:
  - `Tenant DB Pool`: PostgreSQL (1 БД = 1 клиент)
  - `Analytics DB Pool`: ClickHouse (1 инстанс на tenant)
  - `Users DB`: PostgreSQL (глобальная, с tenant_id)
- **Шина данных**: Apache Kafka (все события: телеметрия, инциденты, метрики использования)
- **Платёжные системы**: ЮKassa, СБП через `Payment Gateway Adapter`
- **Dev-портал**: `dev.agrofarm-saas.ru` — документация, API key management

### Диаграмма
См. `Task5/C2.puml` — полная C2-диаграмма архитектуры.

---

## 4. Обоснование выбора мультитенантности

### Почему не single-tenant (dedicated)?
- Высокая TCO: отдельная инфраструктура на клиента.
- Сложность обновлений и мониторинга.
- Невозможность быстрого онбординга.

### Почему не логическая изоляция (`tenant_id`)?
- Риск утечки данных при ошибках в коде.
- Невозможность гарантировать соответствие регуляторным требованиям.
- Сложность резервного копирования и восстановления на уровне клиента.

### Почему **БД на клиента**?
- ✅ Физическая изоляция данных — доверие клиентов.
- ✅ Простое резервное копирование и восстановление.
- ✅ Возможность кастомизации схемы (для enterprise).
- ✅ Умеренные накладные расходы (PostgreSQL легко масштабируется).

---

## 5. Аргументация ключевых решений

### Kafka как единая шина событий
- Все события (телеметрия, инциденты, API-вызовы) → Kafka.
- `Usage Collector` читает асинхронно → агрегирует по `tenant_id` → передаёт в `Billing Service`.
- **Преимущество**: отказоустойчивость, масштабируемость, возможность replay.

### Модель пользователей
- Глобальная `Users DB` с полем `tenant_id`.
- Каждый пользователь привязан к одному тенанту.
- **Преимущество**: единый логин для всех клиентов, изоляция на уровне сервиса.

### Dev-портал
- DevOps клиента получает API key → вызывает `API Gateway` напрямую.
- **Преимущество**: безопасность, простота.

---

## 6. Риски и митигации

| Риск | Митигация |
|------|----------|
| **Сложность управления сотнями БД** | Автоматизация через IaC (Terraform) + operator-паттерн в Kubernetes |
| **Разрастание метрик биллинга** | Отдельная Kafka-топика `usage-events`, TTL-политики в ClickHouse |
| **Нагрузка на API Gateway** | Auto-scaling + rate limiting per tenant |
| **Отказ платёжных систем** | Retry-механизмы + ручной режим выставления счётов |

---

## 7. Следствия

- Все новые клиенты подключаются через **единый онбординг-процесс**.
- Текущая компания **не имеет привилегий** — работает как обычный tenant.
- Архитектура позволяет **собирать анонимизированные данные** для улучшения ИИ-моделей (с согласия клиентов).
- Готова к **горизонтальному масштабированию**.

---

## 8. Приложения

- Диаграмма C2: `Task5/C2.puml`
- Диаграмма C1: `Task5/C1.puml`
